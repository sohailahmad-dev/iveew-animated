"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.runScript = exports.Scripts = void 0;
const tslib_1 = require("tslib");
const childProcess = tslib_1.__importStar(require("child_process"));
const util_1 = require("util");
const common_1 = require("../common");
const exec = (0, util_1.promisify)(childProcess.exec);
var Scripts;
(function (Scripts) {
    Scripts["After"] = "After";
    Scripts["Token"] = "Token";
})(Scripts = exports.Scripts || (exports.Scripts = {}));
const EXEC_TIMEOUT = 5000; // ms
async function runScript(script, configPath, type) {
    const scriptWithCD = `cd ${configPath} && ${script}`;
    const { stdout } = await exec(scriptWithCD, { timeout: EXEC_TIMEOUT }).catch((err) => {
        const { stderr = "" } = err;
        const firstStdErrLine = stderr.split("\n")[0];
        // This child process will be SIGTERM-ed if it times out.
        throw (0, common_1.wrapError)(err.signal === "SIGTERM"
            ? `${type} script timed out`
            : `${type} script failed`, err, `Tried running: '${script}'`, firstStdErrLine);
    });
    return stdout;
}
exports.runScript = runScript;
